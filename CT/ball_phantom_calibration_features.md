# 多球标定新增功能说明

## 概述

在多球标定对话框中新增了两个重要的数据预处理功能，专门用于处理实际DICOM投影数据。

## 新增功能

### 1. 数据旋转功能

**位置**: 实际数据与分割参数 > 数据旋转

**选项**:
- **不旋转**: 保持原始数据方向（默认）
- **顺时针90度**: 将投影数据顺时针旋转90度
- **逆时针90度**: 将投影数据逆时针旋转90度

**实现细节**:
```python
# 顺时针90度
g = np.rot90(g, k=-1, axes=(1, 2))

# 逆时针90度
g = np.rot90(g, k=1, axes=(1, 2))
```

**注意事项**:
- 旋转90度后，数据的行列数会互换
- 系统会自动根据旋转后的实际数据形状更新几何参数
- 原始DICOM的行列信息会在控制台中显示以供参考

### 2. 数据预处理功能

**位置**: 实际数据与分割参数 > 应用数据预处理

**选项**:
- 复选框，默认勾选（启用）

**处理步骤**:

#### 步骤1: 归一化
```python
project /= np.max(project)
```
- 将数据除以最大值，归一化到[0, 1]范围
- 确保数据在统一的尺度上

#### 步骤2: 负对数变换
```python
project = leapct.negLog(project)
```
- 应用负对数变换
- 这是CT重建中常用的预处理步骤，将透射数据转换为投影数据

**调试信息**:
程序会在控制台输出每个步骤的统计信息：
- 预处理前: min, max, mean
- 归一化后: min, max, mean  
- 负对数后: min, max, mean

## 使用流程

1. 打开多球标定对话框
2. 取消勾选"使用模拟数据"
3. 选择包含DICOM文件的投影数据文件夹
4. 设置分割参数（阈值、最小/最大球体尺寸）
5. **[新增]** 选择数据旋转方式（如果需要）
6. **[新增]** 确认是否应用数据预处理（默认启用）
7. 点击"运行标定"

## 数据处理顺序

对于实际数据，处理顺序如下：

```
1. 加载DICOM数据
   ↓
2. 应用旋转（如果选择）
   ↓
3. 应用预处理（如果勾选）
   - 归一化
   - 负对数
   ↓
4. 更新几何参数（考虑旋转影响）
   ↓
5. 执行标定
```

## 适用场景

### 何时使用旋转功能
- 投影数据的方向与标准方向不一致
- 需要校正数据采集时的方向偏差
- 匹配特定的重建坐标系

### 何时使用预处理功能
- **推荐默认启用**
- 处理原始透射数据（transmission data）
- 确保数据在正确的数值范围内
- 提高标定的数值稳定性

### 何时禁用预处理
- 数据已经过预处理
- 数据已经是投影域数据（projection domain）
- 进行特殊的实验或调试

## 技术细节

### 旋转后的几何参数更新

旋转90度后，行列数会自动更新：

```python
if rotation_option in [1, 2]:  # 90度旋转
    numRows = g.shape[2]  # 使用旋转后的实际形状
    numCols = g.shape[1]  # 使用旋转后的实际形状
else:
    numRows = dicom_info["Rows"]
    numCols = dicom_info["Columns"]
```

### 数据维度

- **输入数据形状**: (numAngles, Rows, Columns)
- **旋转后形状**: (numAngles, Columns, Rows)  # 行列互换
- **预处理**: 保持形状不变，只改变数值

## 输出信息

标定结果文件中会包含：
- 使用的旋转选项（通过数据形状体现）
- 原始DICOM参数和实际使用的参数
- 预处理的统计信息（控制台输出）

## 示例

### 完整的实际数据处理示例

```python
# 1. 加载数据
g, dicom_info = loadDICOMImages("path/to/dicom/folder")
print("Original shape:", g.shape)  # (100, 2096, 4000)

# 2. 逆时针旋转90度
g = np.rot90(g, k=1, axes=(1, 2))
print("After rotation:", g.shape)  # (100, 4000, 2096)

# 3. 归一化
g = g / np.max(g)
print("After normalization - max:", np.max(g))  # 1.0

# 4. 负对数
g = leapct.negLog(g)

# 5. 更新几何参数
numRows = g.shape[2]  # 2096
numCols = g.shape[1]  # 4000

# 6. 执行标定
cal = ball_phantom_calibration(leapct, T_z, g, ...)
```

## 注意事项

1. **仅对实际数据有效**: 这些功能仅在使用实际DICOM数据时可用，模拟数据不需要这些预处理
2. **顺序很重要**: 先旋转，后预处理
3. **检查输出**: 始终检查控制台输出，确认数据形状和数值范围符合预期
4. **保存设置**: 标定结果会保存到JSON和TXT文件中，便于追溯使用的参数

## 故障排除

### 问题：标定结果不理想
- 尝试不同的旋转选项
- 检查是否需要启用/禁用预处理
- 调整分割阈值和尺寸参数

### 问题：数据形状错误
- 确认旋转选项是否正确
- 检查控制台输出的形状信息
- 验证DICOM数据是否正确加载

### 问题：数值异常
- 检查预处理是否启用
- 查看控制台输出的统计信息
- 确认原始数据的数值范围是否合理


# 传统分割检测功能使用说明

## 功能概述

本模块实现了基于ITK的传统分割算法，包括：

### 区域生长分割
支持三种不同的区域生长方法：

1. **ConnectedThreshold（连通阈值）**
2. **ConfidenceConnected（置信连接）**
3. **NeighborhoodConnected（邻域连接）**

### OTSU阈值分割
自动阈值分割方法：

1. **单阈值OTSU分割**：二分类（前景/背景）
2. **多阈值OTSU分割**：多分类（支持2-5个阈值）

## 使用步骤

### 步骤1：加载数据
首先在主界面中加载CT数据（通过"文件" -> "导入文件"菜单）。

### 步骤2：选择种子点

有两种方式选择种子点：

#### 方式1：先选择种子点，再打开对话框（推荐）
1. 在任意切片视图（Axial/Sagittal/Coronal）中**右键点击**目标区域
2. 在弹出菜单中选择"**添加区域生长种子点**"
3. 重复上述步骤，可以添加多个种子点
4. 种子点会在图像上用红色十字和圆圈标记
5. 状态栏会显示已添加的种子点数量
6. 打开菜单"**传统分割检测**" -> "**区域生长**"

#### 方式2：在对话框中选择
1. 打开菜单"**传统分割检测**" -> "**区域生长**"
2. 在对话框中点击"**从主界面选择种子点**"按钮
3. 对话框会关闭，返回主界面
4. 在切片视图中右键添加种子点（同方式1）
5. 添加完成后，重新打开"**传统分割检测**" -> "**区域生长**"菜单

### 步骤3：设置参数

在区域生长对话框中：

#### 1. 选择算法类型

##### ConnectedThreshold（连通阈值）
- **适用场景**：目标区域灰度值相对均匀
- **主要参数**：
  - 下阈值：连通区域的最小灰度值
  - 上阈值：连通区域的最大灰度值
- **使用建议**：先观察直方图确定合适的阈值范围

##### ConfidenceConnected（置信连接）
- **适用场景**：不确定阈值范围，希望算法自动计算
- **主要参数**：
  - 倍增因子：控制阈值范围（均值 ± 倍增因子 × 标准差）
  - 迭代次数：迭代次数越多，边界越精细
- **使用建议**：
  - 倍增因子越大，分割区域越大（推荐2.0-3.0）
  - 迭代次数推荐3-10次

##### NeighborhoodConnected（邻域连接）
- **适用场景**：图像有一定噪声
- **主要参数**：
  - 下阈值和上阈值
  - 迭代次数
- **特点**：结合阈值范围和邻域一致性

#### 2. 设置其他参数
- **替换值**：分割区域将被设置为此值（默认255）
- **透明度**：融合显示时的透明度（10-100%）
- **颜色**：融合显示时的颜色（红/绿/蓝/黄/青/品红）

### 步骤4：开始分割

1. 点击"**开始分割**"按钮
2. 等待分割完成（进度对话框会显示）
3. 选择要加载的结果：
   - **是**：加载融合图像（推荐，可直观看到分割效果）
   - **否**：加载纯分割结果
   - **取消**：不加载任何图像

## 提示和技巧

### 种子点选择
- 在目标区域的中心或代表性位置选择种子点
- 可以选择多个种子点以提高分割准确性
- 不同切片视图（Axial/Sagittal/Coronal）都可以选择种子点
- 右键菜单中可以"清除所有种子点"

### 参数调整
- **ConnectedThreshold**：先从窄阈值范围开始，逐渐扩大
- **ConfidenceConnected**：倍增因子2.5通常是个好的起点
- **NeighborhoodConnected**：适合处理CT图像中的软组织分割

### 结果查看
- 融合显示模式下，可以在四个视图中查看分割结果
- 可以调整窗宽窗位来观察细节
- 可以通过3D视图查看分割的立体效果

## 算法说明

### ConnectedThreshold（连通阈值）
从种子点开始，递归生长包含所有灰度值在[下阈值, 上阈值]范围内的连通像素。

### ConfidenceConnected（置信连接）
自动计算种子点邻域的统计信息（均值和标准差），阈值范围 = 均值 ± 倍增因子 × 标准差。通过迭代逐步扩展分割区域。

### NeighborhoodConnected（邻域连接）
结合阈值约束和邻域一致性，通过多次迭代细化分割边界，对噪声有更好的鲁棒性。

## 技术细节

- **种子点坐标**：自动转换为ITK的(x, y, z)索引格式
- **融合显示**：使用RGB叠加，支持透明度和颜色自定义
- **结果保存**：临时保存在系统临时目录，可通过导出功能永久保存
- **视图同步**：种子点标记在所有切片视图中保持同步

## 常见问题

**Q：为什么我添加种子点后没有标记显示？**
A：确保在有父窗口引用的切片视图中添加。检查是否加载了数据。

**Q：如何删除单个种子点？**
A：目前只支持清除所有种子点。建议先清除，再重新选择。

**Q：分割结果为空怎么办？**
A：
1. 检查种子点是否选在目标区域内
2. 调整阈值范围（ConnectedThreshold）
3. 增大倍增因子（ConfidenceConnected）
4. 尝试其他算法

**Q：分割区域过大怎么办？**
A：
1. 减小阈值范围
2. 减小倍增因子
3. 减少迭代次数

**Q：分割区域过小怎么办？**
A：
1. 扩大阈值范围
2. 增大倍增因子
3. 增加迭代次数
4. 添加更多种子点

---

## OTSU阈值分割使用说明

### 功能特点

OTSU阈值分割是一种**自动阈值选择方法**，无需用户手动设置阈值或选择种子点：

- **全局分割**：基于整个图像的灰度直方图
- **自动计算**：通过最大化类间方差自动确定最佳阈值
- **无需种子点**：不需要用户交互选择种子点
- **快速高效**：计算速度快，适合实时应用

### 使用步骤

#### 步骤1：加载数据
在主界面中加载CT数据（通过"文件" -> "导入文件"菜单）。

#### 步骤2：打开OTSU分割
选择菜单"**传统分割检测**" -> "**OTSU阈值分割**"

#### 步骤3：设置参数

##### 基本参数

1. **直方图bins数量**（默认128）
   - 计算阈值时使用的直方图bins数量
   - 通常128或256
   - bins越多越精确，但计算时间稍长

2. **输出模式**
   - **二值掩码输出**（推荐）：前景设为指定值，背景设为0
   - **保留原始灰度值**：保持原始像素值，只移除背景

3. **掩码参数**（二值掩码模式）
   - **前景值**：分割区域的像素值（默认255）
   - **背景值**：非分割区域的像素值（默认0）

##### 阈值模式

1. **单阈值（二分类）**
   - 将图像分为前景和背景两类
   - 适合大多数情况

2. **多阈值**
   - 将图像分为多个类别（2-5个阈值）
   - 适合有多个明显灰度区域的图像
   - 例如：背景、软组织、骨骼等

##### 显示选项

- **融合显示**：将分割结果叠加在原始图像上（推荐）
- **透明度**：调整融合显示的透明度
- **颜色**：选择分割结果的显示颜色（默认绿色）

#### 步骤4：查看结果

分割完成后会显示：
- 计算得到的阈值（单阈值或多个阈值）
- 分割结果路径
- 融合图像路径（如果选择了融合显示）

**多颜色显示**：
- **单阈值模式**：使用您选择的单一颜色显示分割结果
- **多阈值模式**：自动为每个类别分配不同颜色
  * 标签1：红色
  * 标签2：绿色
  * 标签3：蓝色
  * 标签4：黄色
  * 标签5：品红
  * 标签6：青色
  * 更多标签会循环使用这些颜色

### OTSU算法原理

OTSU算法通过最大化类间方差来自动选择最佳阈值：

1. **计算灰度直方图**：统计图像中各灰度值的像素数量
2. **遍历所有可能的阈值**：从最小到最大灰度值
3. **计算类间方差**：对于每个阈值，计算前景和背景的类间方差
4. **选择最佳阈值**：使类间方差最大的阈值即为最佳阈值

**公式**：
```
σ²_between = w₀ × w₁ × (μ₀ - μ₁)²
```
其中：
- w₀, w₁：前景和背景的概率
- μ₀, μ₁：前景和背景的平均灰度值

### 适用场景

#### ✅ 适合OTSU的情况

1. **双峰直方图**：图像直方图呈现明显的双峰分布
2. **灰度差异明显**：前景和背景灰度值差异较大
3. **快速分割需求**：需要快速自动分割
4. **批量处理**：需要对多张图像进行一致性分割

#### ❌ 不适合OTSU的情况

1. **单峰直方图**：前景和背景灰度值接近
2. **噪声较多**：图像包含大量噪声
3. **光照不均**：图像光照不均匀
4. **复杂场景**：需要分割多个复杂目标

### 对比：OTSU vs 区域生长

| 特性 | OTSU阈值分割 | 区域生长 |
|------|-------------|----------|
| **种子点** | 不需要 | 需要 |
| **计算速度** | 快 | 较慢 |
| **交互性** | 无 | 需要用户选择种子点 |
| **适用场景** | 全局分割、双峰直方图 | 局部分割、连通区域 |
| **参数调整** | 少（主要是bins数量） | 多（阈值/倍增因子/迭代次数） |
| **分割精度** | 全局最优 | 局部连通 |

### 使用建议

1. **先尝试OTSU**：
   - 如果不确定用哪种方法，先尝试OTSU
   - OTSU简单快速，无需设置复杂参数

2. **观察直方图**：
   - 在使用OTSU前，先观察右侧的灰度直方图
   - 如果直方图呈现明显的双峰，OTSU效果会很好

3. **结合使用**：
   - 可以先用OTSU进行粗分割
   - 再用区域生长进行精细分割

4. **多阈值分割**：
   - 当图像有多个明显的灰度区域时，使用多阈值
   - 例如：CT图像中的空气、软组织、骨骼

### 常见问题

**Q：OTSU分割结果不理想怎么办？**
A：
1. 检查图像直方图是否为双峰分布
2. 尝试预处理：先进行去噪或增强对比度
3. 考虑使用多阈值分割
4. 改用区域生长等其他方法

**Q：多阈值应该设置几个？**
A：
- 根据图像的灰度区域数量决定
- 一般2-3个阈值就足够
- 阈值过多可能导致过度分割

**Q：计算出的阈值如何理解？**
A：
- 单阈值：小于阈值的为背景，大于的为前景
- 多阈值：将图像分为n+1个区域（n为阈值数量）
- 显示的阈值可以作为后续手动分割的参考

**Q：为什么我的结果全是前景或全是背景？**
A：
1. 检查输入数据是否正确
2. 可能图像本身不适合OTSU（单峰直方图）
3. 尝试调整直方图bins数量
4. 考虑使用其他分割方法

**Q：多阈值模式下如何查看不同的类别？**
A：
- **推荐：选择融合显示**，系统会自动为每个类别分配不同颜色
  - 标签1=红色，标签2=绿色，标签3=蓝色等
  - 可以在四个视图窗口中清晰观察不同类别的分布
- **纯分割结果**：不同标签显示为不同灰度值
  - 标签0=黑色（背景）
  - 标签1、2、3等显示为递增的灰度值
  - 系统自动将标签映射到可见范围（0, 255, 510, 765...）
- 每个类别的像素数量会在控制台输出

**Q：为什么多阈值的纯分割结果看起来是灰度图？**
A：
- 这是正常的！多阈值分割产生的是**标签图像**，不是二值图像
- 不同的标签（0, 1, 2, 3...）会被映射到不同的灰度值
- 标签0（背景）=黑色
- 标签1、2、3等=递增的灰度值（间隔255）
- 如果想看到清晰的分类，建议使用**融合显示**（多颜色）

## 参考文献

- ITK Software Guide: Region Growing Segmentation
- ITK Software Guide: Thresholding Filters
- SimpleITK Documentation: Segmentation Filters
- Otsu, N. "A threshold selection method from gray-level histograms." IEEE Trans. Sys. Man. Cyber. 9(1), 62-66 (1979)

